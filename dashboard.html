<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Excellent Studies ZA | Loyalty Dashboard</title>
<style>
body{
    font-family:Arial;
    background:#fff;
    padding:20px;
}
.container{
    max-width:900px;
    background:black;
    color:white;
    margin:auto;
    padding:30px;
    border-radius:12px;
}
h1{text-align:center;}
a{
    color:black;
    background:white;
    padding:6px 12px;
    border-radius:6px;
    text-decoration:none;
    margin:4px;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th, td{
    border:1px solid white;
    padding:8px;
    text-align:left;
}
th{background:#222;}
td{background:#111;}
label{margin-right:6px;}
input, select{
    padding:4px 6px;
    border-radius:6px;
    border:none;
    margin:0 4px;
}
.filter-container{
    text-align:center;
    margin-top:15px;
    margin-bottom:15px;
}
</style>
</head>
<body>

<script>
// Password protection
const password = "Excell2025"; // Change this to your secure password
let attempt = prompt("Enter admin password to access dashboard:");
if(attempt !== password){
    alert("Incorrect password! Access denied.");
    window.location.href = "index.html"; // redirect if wrong
}
</script>

<div class="container">

<h1>ðŸŽ¯ Loyalty Tracking Dashboard</h1>

<div style="text-align:center;margin:10px 0;">
    <a href="index.html">â¬… Back to Booking</a>
    <a href="prices.html">ðŸ’° Prices</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
</div>

<!-- Filters -->
<div class="filter-container">
<label>Filter by Month:</label>
<input type="month" id="filterMonth">

<label>Filter by Subject:</label>
<select id="filterSubject">
    <option value="">All Subjects</option>
    <option>Mathematics</option>
    <option>Mathematical Literacy</option>
    <option>Accounting</option>
    <option>Business Studies</option>
    <option>Physical Science</option>
    <option>Geography</option>
    <option>Life Science</option>
</select>
</div>

<table>
<thead>
<tr>
<th>Student Name</th>
<th>Email</th>
<th>Total Sessions</th>
<th>Discount Eligible?</th>
<th>Next Booking</th>
<th>Subject</th>
</tr>
</thead>
<tbody id="dashboardBody">
<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
</tbody>
</table>

</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbys08KAuNNsU6kY7n0CjyiHQ-5l02ocqvlOTTePCp-ces9wWYghPUbn6UO_d9u3CmZY/exec";
const filterMonth = document.getElementById("filterMonth");
const filterSubject = document.getElementById("filterSubject");
let allData = [];

function loadDashboard(data){
    const tbody = document.getElementById("dashboardBody");
    tbody.innerHTML="";

    const students = {};

    data.forEach(entry => {
        const entryDate = new Date(entry.date + " " + entry.time);
        const monthFilter = filterMonth.value ? new Date(filterMonth.value + "-01") : null;
        const subjectFilter = filterSubject.value;

        // Skip if filters don't match
        if(monthFilter && (entryDate.getMonth() !== monthFilter.getMonth() || entryDate.getFullYear() !== monthFilter.getFullYear())){
            return;
        }
        if(subjectFilter && entry.subject !== subjectFilter){
            return;
        }

        const email = entry.email;
        if(!students[email]){
            students[email] = {
                name: entry.name,
                email: email,
                sessions: 0,
                nextBooking: entry.date + " " + entry.time,
                subjects:[entry.subject]
            };
        } else {
            if(!students[email].subjects.includes(entry.subject)){
                students[email].subjects.push(entry.subject);
            }
        }
        students[email].sessions +=1;

        const currentNext = new Date(students[email].nextBooking);
        if(entryDate < currentNext){
            students[email].nextBooking = entry.date + " " + entry.time;
        }
    });

    for(const key in students){
        const s = students[key];
        const discountEligible = s.sessions >=5 ? "Yes (15% OFF)" : "No";
        const row = document.createElement("tr");
        row.innerHTML = `<td>${s.name}</td>
                         <td>${s.email}</td>
                         <td>${s.sessions}</td>
                         <td>${discountEligible}</td>
                         <td>${s.nextBooking}</td>
                         <td>${s.subjects.join(", ")}</td>`;
        tbody.appendChild(row);
    }

    if(Object.keys(students).length === 0){
        tbody.innerHTML="<tr><td colspan='6' style='text-align:center;'>No matching records</td></tr>";
    }
}

// Re-load dashboard when filters change
filterMonth.addEventListener("change",()=>loadDashboard(allData));
filterSubject.addEventListener("change",()=>loadDashboard(allData));

fetch(SCRIPT_URL)
.then(res=>res.json())
.then(data=>{
    allData = data;
    loadDashboard(allData);
})
.catch(err=>{
    document.getElementById("dashboardBody").innerHTML="<tr><td colspan='6'>Error loading data</td></tr>";
    console.error(err);
});
</script>

</body>
</html>
