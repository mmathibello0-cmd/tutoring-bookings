<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Excellent Studies ZA â€” Book a Session</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f7f7f7;margin:0;padding:18px;}
  .container{max-width:820px;margin:18px auto;background:#000;color:#fff;padding:26px;border-radius:12px;}
  h1{margin:0 0 6px;text-align:center}
  .tagline{color:#ddd;text-align:center;margin-bottom:16px}
  label{display:block;font-weight:700;margin:12px 0 6px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:none}
  textarea{min-height:90px;resize:vertical}
  .nav{display:flex;gap:12px;justify-content:center;margin-bottom:16px;flex-wrap:wrap}
  .nav a{background:#fff;color:#000;padding:10px 16px;border-radius:999px;text-decoration:none;font-weight:700}
  .btn{background:#fff;color:#000;border:none;padding:12px;border-radius:12px;font-weight:700;cursor:pointer;margin-top:14px;width:100%}
  .notice{background:#fff;color:#000;padding:16px;border-radius:10px;margin-top:18px;font-size:14px}
  .small{font-size:13px;color:#ccc}
</style>
</head>
<body>

<div class="container">
  <h1>ðŸ“š Excellent Studies ZA</h1>
  <div class="tagline">Helping students rise from struggle to success</div>

  <div class="nav">
    <a href="index.html">Book</a>
    <a href="prices.html">Prices</a>
    <a href="about.html">About</a>
    <a href="reviews.html">Reviews</a>
    <a href="dashboard.html">Admin</a>
  </div>

  <form id="bookingForm" onsubmit="handleBooking(event)" autocomplete="off">
    <label>Student Full Name</label>
    <input id="name" required />

    <label>Email Address</label>
    <input id="email" type="email" required />

    <label>Select Subject</label>
    <select id="subject" required>
      <option>Mathematics</option>
      <option>Mathematical Literacy</option>
      <option>Accounting</option>
      <option>Business Studies</option>
      <option>Physical Science</option>
      <option>Geography</option>
      <option>Life Science</option>
    </select>

    <label>Select Package</label>
    <select id="package" required onchange="updateAmount()">
      <option value="110">Single Session â€“ R110</option>
      <option value="210">2 Hour Session â€“ R210</option>
      <option value="430">Monthly Package â€“ R430</option>
      <option value="2016">Group Monthly â€“ R2016 (40% OFF)</option>
      <option value="210">University Applications â€“ R210</option>
      <option value="5x2hr">5 Ã— 2-hour sessions (15% OFF) â€” Janâ€“Feb 2026</option>
    </select>

    <label>Session Date</label>
    <input id="date" type="date" required />

    <label>Session Time</label>
    <input id="time" type="time" required />

    <label>Notes (Hours + Grade)</label>
    <textarea id="notes" placeholder="Example: Grade 11 Â· 2 hours weekly"></textarea>

    <button class="btn" type="submit">âœ… Submit & Pay</button>
    <div class="small" style="margin-top:8px">By clicking you will be prompted to pay via PayFast. Bookings are saved immediately.</div>
  </form>

  <div class="notice" id="eftBox">
    <h3>ðŸ’³ EFT Payment Details (if you prefer EFT)</h3>
    <p>Please email proof of payment to: <b>excellent.studies.za@gmail.com</b></p>
    <hr>
    <p><b>Bank:</b> Standard Bank<br>
       <b>Branch:</b> Centurion Lifes Â· <b>Branch Code:</b> 2645<br>
       <b>Account Holder:</b> Miss Reamogetsoe RRM Mokati<br>
       <b>Account Number:</b> 013876252 Â· <b>Type:</b> Current<br>
       <b>SWIFT:</b> SBZAZAJJ</p>
    <p><b>Payment reference:</b> StudentName + Subject</p>
    <p style="text-align:center"><i>Bookings are confirmed once payment proof is received (EFT) or PayFast confirms payment.</i></p>
  </div>
</div>

<script>
/* ----------------- CONFIG ----------------- */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbys08KAuNNsU6kY7n0CjyiHQ-5l02ocqvlOTTePCp-ces9wWYghPUbn6UO_d9u3CmZY/exec";
/* PayFast credentials you provided */
const PAYFAST = {
  merchant_id: "32900789",
  merchant_key: "zp0c3sujcapba",
  // If you later enable passphrase set it here
  passphrase: "" ,
  // pages you upload to your site
  return_url: window.location.origin + "/pay-success.html",
  cancel_url: window.location.origin + "/pay-cancel.html",
  notify_url: SCRIPT_URL
};

/* package mapping for amounts (R) */
function computeAmountForPackage(value) {
  if (value === "5x2hr") {
    // 5 x 2-hour sessions at R210 each before discount = 5*210 = 1050
    // 15% off
    const raw = 5 * 210;
    return (raw * (1 - 0.15)).toFixed(2);
  }
  return Number(value).toFixed(2);
}

/* called when package field changes */
function updateAmount(){
  const pkg = document.getElementById("package").value;
  // no visible amount field right now â€” we calculate on submit
}

/* ----------------- BOOKING FLOW -----------------
1) Save booking to Google Apps Script (SCRIPT_URL)
2) If that succeeds, open PayFast payment form (POST) in new tab/window
3) If PayFast completes, PayFast will redirect to return_url and send IPN to notify_url
-----------------------------------------------*/

async function handleBooking(e){
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const subject = document.getElementById("subject").value;
  const pkg = document.getElementById("package").value;
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const notes = document.getElementById("notes").value.trim();

  if(!name || !email) { alert("Please provide name and email."); return; }

  // determine amount and item_name
  const amount = computeAmountForPackage(pkg);
  const packageLabel = (pkg === "5x2hr") ? "5x 2-hour sessions (15% OFF)" : (document.querySelector("#package option:checked").textContent);

  const booking = {
    type: "booking",
    name, email, subject, package: packageLabel,
    date, time, notes,
    amount
  };

  // Save booking to Google Apps Script (so you have a record even if pay flow fails)
  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(booking)
    });
  } catch(err) {
    // still continue, but inform user
    console.warn("Warning â€” booking save failed (will still attempt payment):", err);
    alert("Warning: Could not save booking to sheet. Payment will proceed â€” please email proof of payment if needed.");
  }

  // Build PayFast form dynamically and submit to PayFast in new window
  submitToPayFast({
    amount,
    item_name: `Excellent Studies ZA â€” ${packageLabel} â€” ${subject} â€” ${name}`,
    name_first: name,
    email_address: email
  });
}

/* Create a form and POST to PayFast */
function submitToPayFast({ amount, item_name, name_first, email_address }) {
  // Create a new window so PayFast opens in a new tab
  const paymentWindow = window.open("", "_blank");

  // Build form
  const form = document.createElement("form");
  form.method = "POST";
  form.action = "https://www.payfast.co.za/eng/process";
  form.target = "_self";

  // Required fields
  const fields = {
    merchant_id: PAYFAST.merchant_id,
    merchant_key: PAYFAST.merchant_key,
    return_url: PAYFAST.return_url,
    cancel_url: PAYFAST.cancel_url,
    notify_url: PAYFAST.notify_url,
    amount: amount,
    item_name: item_name,
    name_first: name_first,
    email_address: email_address,
    // currency default ZAR
    currency: "ZAR"
  };

  // Append hidden inputs
  Object.keys(fields).forEach(k => {
    const i = document.createElement("input");
    i.type = "hidden";
    i.name = k;
    i.value = fields[k];
    form.appendChild(i);
  });

  // If you later want to calculate signature using passphrase, you can add it here.
  // Append the form to the paymentWindow document and submit it
  paymentWindow.document.body.appendChild(form);
  form.submit();
}

/* Helper â€” prefill date with next available day */
(function prefillDate(){
  const dateEl = document.getElementById("date");
  const d = new Date();
  d.setDate(d.getDate()+1);
  const iso = d.toISOString().split("T")[0];
  dateEl.value = iso;
})();
</script>
</body>
</html>
